<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controle de Advert√™ncias</title>
  <link rel="icon" href="data:,">
  <style>
    * { box-sizing: border-box; }
    :root{
      /* escuro (default) */
      --bg:#0b1220; --bg2:#0f172a; --card:#0f1628; --card2:#0c1325; --border:#1f2a44;
      --txt:#e5e7eb; --muted:#9aa4b2; --accent:#22c55e; --accentText:#06270e;
      --btnText:#e5e7eb; --tableHead:#0a1120;
      --field:#0a1120; --fieldBorder:#253555; --fieldShadow:rgba(0,0,0,.35);
    }
    /* claro */
    body[data-theme="light"]{
      --bg:#f5f7fb; --bg2:#eef2f9; --card:#ffffff; --card2:#f8fafc; --border:#e5e7eb;
      --txt:#0f172a; --muted:#596173; --accent:#2563eb; --accentText:#ffffff;
      --btnText:#0f172a; --tableHead:#f4f6fb;
      --field:#ffffff; --fieldBorder:#d9dee8; --fieldShadow:rgba(9,30,66,.15);
    }
    @media (prefers-color-scheme: light){
      body:not([data-theme]){
        --bg:#f5f7fb; --bg2:#eef2f9; --card:#ffffff; --card2:#f8fafc; --border:#e5e7eb;
        --txt:#0f172a; --muted:#596173; --accent:#2563eb; --accentText:#ffffff;
        --btnText:#0f172a; --tableHead:#f4f6fb;
        --field:#ffffff; --fieldBorder:#d9dee8; --fieldShadow:rgba(9,30,66,.15);
      }
    }

    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,sans-serif;
      color:var(--txt);
      background:linear-gradient(180deg,var(--bg),var(--bg2));
      display:flex; flex-direction:column; transition: background .25s ease, color .25s ease;
    }

    /* ===== HEADER ===== */
    .topbar{
      position:sticky; top:0; z-index:10; display:flex; align-items:center; justify-content:space-between;
      gap:14px; padding:10px 16px; background:rgba(11,18,32,0.08); backdrop-filter:blur(8px);
      border-bottom:1px solid var(--border);
    }
    body[data-theme="light"] .topbar{ background:rgba(255,255,255,0.7); }
    .brand{display:flex; align-items:center; gap:10px}
    .brand a{display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit}
    .brand img.logo-img{ height: clamp(48px, 8vh, 80px); width:auto; display:block; border-radius:10px; box-shadow: 0 6px 18px rgba(0,0,0,.15) }
    .brand h1{margin:0; font-size:18px; letter-spacing:.2px}
    .userbox{display:flex; gap:10px; align-items:center; color:var(--muted); font-size:14px}
    .icon-btn{padding:8px 12px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--btnText); cursor:pointer; font-weight:600}

    /* ===== LAYOUT ===== */
    .container{max-width:1100px; width:100%; margin:24px auto; padding:0 16px; flex:1}
    .card{
      background:linear-gradient(180deg,var(--card),var(--card2));
      border:1px solid var(--border); border-radius:16px; padding:18px;
      box-shadow:0 18px 40px rgba(0,0,0,.10);
    }
    .tabs{display:flex; gap:10px; margin-bottom:12px}
    .tabs button{padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:transparent; color:var(--txt); cursor:pointer; font-weight:700}
    .tabs button.active{background:var(--accent); color:var(--accentText); border-color:transparent}
    .grid-4{display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:12px}
    .grid-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    label{display:block; font-size:14px; color:var(--muted)}

    /* ===== CAMPOS DESTACADOS ===== */
    .field{
      width:100%; margin-top:6px; padding:12px 14px; border-radius:14px;
      border:1.5px solid var(--fieldBorder); background:var(--field);
      box-shadow: 0 8px 20px var(--fieldShadow);
      color:var(--txt); outline:none; transition:border-color .15s ease, box-shadow .15s ease;
    }
    .field:focus{
      border-color: color-mix(in oklab, var(--accent) 60%, var(--fieldBorder) 40%);
      box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent) 25%, transparent);
    }
    input[readonly].field{opacity:.9}

    /* select tema + contraste */
    select.field, select.field option { color:var(--txt); background:var(--field) }
    body[data-theme="light"] select.field, body[data-theme="light"] select.field option{ color:#0f172a; background:#ffffff }

    button{padding:12px 16px; border-radius:12px; border:1px solid var(--border); cursor:pointer; font-weight:700}
    .primary{ background:var(--accent); color:var(--accentText); border-color:transparent }
    .secondary{ background:transparent; color:var(--btnText); }
    .danger{ background:#ef4444; color:#fff; border-color:#7f1d1d }

    table{width:100%; border-collapse:collapse; margin-top:12px; font-size:14px}
    th,td{border:1px solid var(--border); padding:10px; text-align:left}
    th{background:var(--tableHead)}
    a{ color:color-mix(in oklab, var(--accent) 70%, #ffffff 30%); text-decoration:underline; }
    .muted{color:var(--muted)}
    .hidden{display:none}
    .footer{ text-align:center; padding:14px; color:var(--muted); font-size:12px; }
    .container-sm{max-width:420px; width:100%; margin:40px auto; padding:0 16px}

    /* responsivo */
    @media (max-width: 820px){
      .grid-4{grid-template-columns:1fr 1fr}
      .grid-3{grid-template-columns:1fr 1fr}
      .brand h1{font-size:16px}
    }
    @media (max-width: 480px){
      .grid-4, .grid-3{grid-template-columns:1fr}
    }

    /* √çcones-bot√£o */
    .icon{
      display:inline-flex; align-items:center; justify-content:center;
      width:36px; height:36px; border-radius:10px; border:1px solid var(--border);
      background:transparent; cursor:pointer; font-size:18px;
    }
    .icon[title]{ position:relative }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <a href="#" id="home-link" title="Ir para Colaboradores">
        <img src="./logo.png" alt="Ferreira Transportes & Log√≠stica" class="logo-img" />
        <h1>Controle de Advert√™ncias</h1>
      </a>
    </div>
    <div class="userbox">
      <button id="btn-theme" class="icon-btn" title="Alternar tema">üåô Tema</button>
      <span id="user-email">Deslogado</span>
      <button id="btn-logout" class="icon-btn hidden">Sair</button>
    </div>
  </header>

  <!-- LOGIN -->
  <main id="view-auth" class="container-sm">
    <section class="card">
      <h2 style="margin:0 0 12px">Acesse sua conta</h2>
      <label>E-mail
        <input type="email" id="email" placeholder="voce@empresa.com.br" autocomplete="username" class="field" />
      </label>
      <label>Senha
        <input type="password" id="password" placeholder="********" autocomplete="current-password" class="field" />
      </label>
      <div class="row">
        <button id="btn-login" class="primary">Entrar</button>
        <button id="btn-signup" class="secondary">Criar conta</button>
        <button id="btn-recover" class="secondary">Esqueci minha senha</button>
      </div>
      <p id="auth-msg" class="muted"></p>
    </section>
  </main>

  <!-- APP -->
  <main id="view-app" class="container hidden">
    <div class="tabs">
      <button data-tab="colab" class="active">Colaboradores</button>
      <button data-tab="adv">Advert√™ncias</button>
      <button data-tab="regs">Registros de Advert√™ncia</button>
    </div>

    <!-- COLABORADORES (tela principal) -->
    <section id="tab-colab" class="card">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <h2 style="margin:0">Colaboradores</h2>
        <button id="toggle-colab-form" class="primary">Cadastrar Colaborador</button>
      </div>

      <form id="form-colab" class="grid-3 hidden" style="margin-top:16px">
        <label>Nome
          <input id="c_nome" placeholder="Ex.: Jandira Silva" class="field" required />
        </label>
        <label>CPF
          <input id="c_cpf" placeholder="000.000.000-00" class="field" />
        </label>
        <label>CTPS
          <input id="c_ctps" placeholder="CTPS" class="field" />
        </label>
        <label>S√©rie
          <input id="c_serie" placeholder="S√©rie" class="field" />
        </label>
        <div class="row" style="grid-column:1/-1">
          <button class="primary" type="submit">Adicionar</button>
          <button type="button" class="secondary" id="cancel-colab-form">Cancelar</button>
        </div>
      </form>

      <table style="margin-top:16px">
        <thead>
          <tr><th>Nome</th><th>CPF</th><th>CTPS</th><th>S√©rie</th><th style="width:1%"></th></tr>
        </thead>
        <tbody id="tbl-colab"></tbody>
      </table>
      <p id="colab-empty" class="muted">Nenhum colaborador cadastrado.</p>
    </section>

    <!-- ADVERT√äNCIAS (apenas cadastro/edi√ß√£o) -->
    <section id="tab-adv" class="card hidden">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <h2 style="margin:0">Cadastrar Advert√™ncia</h2>
        <!-- A√ß√µes r√°pidas: novo (üÜï) limpar (üßπ) -->
        <div>
          <button id="btn-new-adv" class="icon" title="Nova advert√™ncia">üÜï</button>
          <button id="btn-clear-adv" class="icon" title="Limpar formul√°rio">üßπ</button>
        </div>
      </div>

      <form id="form-adv" class="grid-4">
        <input type="hidden" id="f_editing_id" />

        <label>Colaborador
          <select id="f_colaborador_id" required class="field"></select>
        </label>
        <label>CPF
          <input id="f_cpf" readonly placeholder="‚Äî" class="field" />
        </label>
        <label>CTPS
          <input id="f_ctps" readonly placeholder="‚Äî" class="field" />
        </label>
        <label>S√©rie
          <input id="f_serie" readonly placeholder="‚Äî" class="field" />
        </label>

        <label>Data da ocorr√™ncia
          <input type="date" id="f_data_ocorrencia" required class="field" />
        </label>
        <label>Data da aplica√ß√£o
          <input type="date" id="f_data_aplicacao" required class="field" />
        </label>

        <label>Tipo de advert√™ncia
          <select id="f_tipo" required class="field">
            <option>Verbal</option>
            <option>Falta n√£o justificada</option>
            <option>Atraso</option>
          </select>
        </label>

        <!-- Subtipo para quando for Verbal -->
        <label id="grp_verbal" class="">
          Subtipo (quando Verbal)
          <select id="f_verbal_sub" class="field">
            <option>Atraso</option>
            <option>Falta n√£o justificada</option>
          </select>
        </label>

        <label style="grid-column:1/-1">Anexo (PNG ou PDF)
          <input type="file" id="f_arquivo" accept=".png,.pdf,image/png,application/pdf" class="field" />
        </label>

        <div class="row" style="grid-column:1/-1">
          <button class="primary" type="submit" title="Salvar (inserir ou atualizar)">üíæ Salvar</button>
        </div>
      </form>
      <p class="muted" id="adv-hint" style="margin-top:8px">Dica: ao trocar de aba, o rascunho do formul√°rio permanece salvo automaticamente.</p>
    </section>

    <!-- REGISTROS (nova aba) -->
    <section id="tab-regs" class="card hidden">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <h2 style="margin:0">Registros de Advert√™ncia</h2>
        <!-- Filtro -->
        <input id="filter" class="field" style="max-width:360px" placeholder="Filtrar por colaborador, CPF ou CTPS" />
      </div>

      <table>
        <thead>
          <tr>
            <th>Colaborador (download)</th>
            <th>CPF</th>
            <th>CTPS</th>
            <th>S√©rie</th>
            <th>Ocorr√™ncia</th>
            <th>Aplica√ß√£o</th>
            <th>Tipo</th>
            <th style="width:1%">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tbl-reg"></tbody>
      </table>
      <p id="empty" class="muted">Nenhum registro ainda.</p>
    </section>
  </main>

  <footer class="footer">Desenvolvido por Bruno Ferreira da Cruz</footer>

  <!-- Supabase UMD -->
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.2/dist/umd/supabase.js"></script>
  <script>
    /*************** CONFIG ***************/
    const SUPABASE_URL = "https://bgophlququlizkwioveu.supabase.co";   // seu projeto
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJnb3BobHF1cXVsaXprd2lvdmV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjM3NDgsImV4cCI6MjA3MDc5OTc0OH0.eJQkx1FDhjeNkKRsRuP2qSEMLvj_u_S_tRevmATJECc";
    const BUCKET = 'adv_docs';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const DRAFT_KEY = 'adv_form_draft_v1';
    const EDIT_KEY  = 'adv_edit_id_v1';

    /*************** ELEMENTOS ***************/
    const E = {
      // auth
      viewAuth: document.getElementById('view-auth'),
      viewApp: document.getElementById('view-app'),
      userEmail: document.getElementById('user-email'),
      btnLogout: document.getElementById('btn-logout'),
      email: document.getElementById('email'),
      password: document.getElementById('password'),
      btnLogin: document.getElementById('btn-login'),
      btnSignup: document.getElementById('btn-signup'),
      btnRecover: document.getElementById('btn-recover'),
      msg: document.getElementById('auth-msg'),
      // header
      homeLink: document.getElementById('home-link'),
      btnTheme: document.getElementById('btn-theme'),
      // tabs
      tabBtns: document.querySelectorAll('.tabs button'),
      tabColab: document.getElementById('tab-colab'),
      tabAdv: document.getElementById('tab-adv'),
      tabRegs: document.getElementById('tab-regs'),
      // colab
      toggleColabForm: document.getElementById('toggle-colab-form'),
      cancelColabForm: document.getElementById('cancel-colab-form'),
      formColab: document.getElementById('form-colab'),
      c_nome: document.getElementById('c_nome'),
      c_cpf: document.getElementById('c_cpf'),
      c_ctps: document.getElementById('c_ctps'),
      c_serie: document.getElementById('c_serie'),
      tblColab: document.getElementById('tbl-colab'),
      colabEmpty: document.getElementById('colab-empty'),
      // adv
      formAdv: document.getElementById('form-adv'),
      f_editing_id: document.getElementById('f_editing_id'),
      f_colab_id: document.getElementById('f_colaborador_id'),
      f_cpf: document.getElementById('f_cpf'),
      f_ctps: document.getElementById('f_ctps'),
      f_serie: document.getElementById('f_serie'),
      f_data_oc: document.getElementById('f_data_ocorrencia'),
      f_data_ap: document.getElementById('f_data_aplicacao'),
      f_tipo: document.getElementById('f_tipo'),
      f_verbal_grp: document.getElementById('grp_verbal'),
      f_verbal_sub: document.getElementById('f_verbal_sub'),
      f_file: document.getElementById('f_arquivo'),
      btnNewAdv: document.getElementById('btn-new-adv'),
      btnClearAdv: document.getElementById('btn-clear-adv'),
      // regs
      filter: document.getElementById('filter'),
      tblReg: document.getElementById('tbl-reg'),
      empty: document.getElementById('empty'),
    };

    /*************** THEME ***************/
    const THEME_KEY = 'ft_theme';
    function applyTheme(theme){
      if(theme) document.body.setAttribute('data-theme', theme);
      else document.body.removeAttribute('data-theme');
      const isLight = (document.body.getAttribute('data-theme')==='light') ||
        (!document.body.hasAttribute('data-theme') && matchMedia('(prefers-color-scheme: light)').matches);
      E.btnTheme.textContent = isLight ? 'üåû Tema' : 'üåô Tema';
    }
    function toggleTheme(){
      const curr = document.body.getAttribute('data-theme');
      const next = curr === 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', next);
      localStorage.setItem(THEME_KEY, next);
      applyTheme(next);
    }
    applyTheme(localStorage.getItem(THEME_KEY));
    E.btnTheme.addEventListener('click', toggleTheme);

    /*************** TABS ***************/
    function setTab(name){
      E.tabBtns.forEach(b => b.classList.toggle('active', b.dataset.tab === name));
      E.tabColab.classList.toggle('hidden', name !== 'colab');
      E.tabAdv .classList.toggle('hidden', name !== 'adv');
      E.tabRegs.classList.toggle('hidden', name !== 'regs');
      // ao trocar de aba, preservamos/gravamos rascunho, ent√£o nada √© perdido
      if(name === 'regs') loadAdv(); // sempre que abrir registros, recarrega
    }
    document.querySelector('[data-tab="colab"]').addEventListener('click', ()=>setTab('colab'));
    document.querySelector('[data-tab="adv"]').addEventListener('click', ()=>setTab('adv'));
    document.querySelector('[data-tab="regs"]').addEventListener('click', ()=>setTab('regs'));
    E.homeLink.addEventListener('click', (ev)=>{ ev.preventDefault(); setTab('colab'); window.scrollTo({top:0,behavior:'smooth'}); });

    /*************** AUTH ***************/
    function setErr(t){ E.msg.textContent = t; E.msg.style.color = '#f87171'; }
    function setOk(t){ E.msg.textContent = t; E.msg.style.color = '#34d399'; }
    function setLogged(session){
      const logged = !!session;
      document.getElementById('user-email').textContent = logged ? session.user.email : 'Deslogado';
      E.viewAuth.classList.toggle('hidden', logged);
      E.viewApp .classList.toggle('hidden', !logged);
      E.btnLogout.classList.toggle('hidden', !logged);
    }
    E.btnLogout.addEventListener('click', async ()=>{ await supabaseClient.auth.signOut(); });
    E.btnLogin.addEventListener('click', async ()=>{
      const email=E.email.value.trim(), password=E.password.value;
      if(!email||!password) return setErr('Preencha e-mail e senha.');
      const { error } = await supabaseClient.auth.signInWithPassword({ email,password });
      if(error) return setErr(error.message);
    });
    E.btnSignup.addEventListener('click', async ()=>{
      const email=E.email.value.trim(), password=E.password.value;
      if(!email||!password) return setErr('Defina um e-mail e uma senha.');
      const { error } = await supabaseClient.auth.signUp({ email,password });
      if(error) return setErr(error.message);
      setOk('Conta criada! (confirma√ß√£o desativada).');
    });
    E.btnRecover.addEventListener('click', async ()=>{
      const email=E.email.value.trim(); if(!email) return setErr('Digite seu e-mail.');
      const { error } = await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin });
      if(error) return setErr(error.message);
      setOk('Se existir, enviaremos um link de redefini√ß√£o.');
    });

    /*************** COLABORADORES ***************/
    E.toggleColabForm.addEventListener('click', ()=>E.formColab.classList.toggle('hidden'));
    E.cancelColabForm.addEventListener('click', ()=>E.formColab.classList.add('hidden'));

    async function loadColabs(){
      // ordena alfabeticamente no servidor (garante consist√™ncia)
      const { data, error } = await supabaseClient.from('colaboradores').select('*').order('nome',{ascending:true});
      if(error){ console.error(error); return; }
      renderColabs(data||[]);
      fillColabSelect(data||[]);
    }
    function renderColabs(items){
      E.tblColab.innerHTML = '';
      if(!items.length){ E.colabEmpty.classList.remove('hidden'); return; }
      E.colabEmpty.classList.add('hidden');
      for(const c of items){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(c.nome)}</td>
          <td>${escapeHtml(c.cpf||'')}</td>
          <td>${escapeHtml(c.ctps||'')}</td>
          <td>${escapeHtml(c.serie||'')}</td>
          <td>
            <button class="icon" title="Excluir" aria-label="Excluir">üóëÔ∏è</button>
          </td>`;
        tr.querySelector('button').addEventListener('click', ()=>delColab(c.id));
        E.tblColab.appendChild(tr);
      }
    }
    function fillColabSelect(items){
      E.f_colab_id.innerHTML = '';
      if(!items.length){
        E.f_colab_id.innerHTML = '<option value="">‚Äî Cadastre um colaborador ‚Äî</option>';
        E.f_cpf.value = E.f_ctps.value = E.f_serie.value = '';
        return;
      }
      for(const c of items){
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.nome;
        opt.dataset.cpf = c.cpf||'';
        opt.dataset.ctps = c.ctps||'';
        opt.dataset.serie = c.serie||'';
        E.f_colab_id.appendChild(opt);
      }
      syncColabInfo();
    }
    function syncColabInfo(){
      const opt = E.f_colab_id.selectedOptions[0];
      if(!opt){ E.f_cpf.value = E.f_ctps.value = E.f_serie.value=''; return; }
      E.f_cpf.value = opt.dataset.cpf || '';
      E.f_ctps.value = opt.dataset.ctps || '';
      E.f_serie.value = opt.dataset.serie || '';
      saveDraft(); // atualiza rascunho
    }
    E.f_colab_id.addEventListener('change', syncColabInfo);

    E.formColab.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const payload = {
        nome: E.c_nome.value.trim(),
        cpf:  E.c_cpf.value.trim() || null,
        ctps: E.c_ctps.value.trim() || null,
        serie:E.c_serie.value.trim() || null,
      };
      if(!payload.nome) return;

      const { data, error } = await supabaseClient
        .from('colaboradores').insert(payload).select().single();
      if(error){ alert('Erro ao salvar colaborador: ' + error.message); return; }

      e.target.reset();
      E.formColab.classList.add('hidden');
      await loadColabs();
      if (data?.id) { E.f_colab_id.value = data.id; syncColabInfo(); }
    });

    async function delColab(id){
      if(!confirm('Excluir colaborador? (isso n√£o apaga registros antigos)')) return;
      await supabaseClient.from('colaboradores').delete().eq('id', id);
      // fallback de 2s garante tela atualizada
      setTimeout(loadColabs, 2000);
    }

    /*************** REGISTROS ***************/
    let advCache = []; // mant√©m em mem√≥ria para filtro
    async function loadAdv(){
      // prefer√™ncia: ordenar alfabeticamente no servidor
      let query = supabaseClient.from('adv_registros_view').select('*').order('colaborador_nome',{ascending:true});
      const { data, error } = await query;
      if(error){ console.error(error); return; }
      advCache = (data||[]).slice().sort((a,b)=> (a.colaborador_nome||'').localeCompare(b.colaborador_nome||''));
      renderAdv(advCache);
    }

    function renderAdv(items){
      E.tblReg.innerHTML = '';
      if(!items.length){ E.empty.classList.remove('hidden'); return; }
      E.empty.classList.add('hidden');

      for(const r of items){
        const tr = document.createElement('tr');

        const tdNome = document.createElement('td');
        if(r.arquivo_path){
          const { data: pub } = supabaseClient.storage.from(BUCKET).getPublicUrl(r.arquivo_path);
          const a = document.createElement('a');
          a.href = pub.publicUrl; a.target = '_blank'; a.rel = 'noopener';
          a.textContent = r.colaborador_nome || r.colaborador || '‚Äî';
          tdNome.appendChild(a);
        } else {
          tdNome.textContent = r.colaborador_nome || r.colaborador || '‚Äî';
        }

        const tdCpf = document.createElement('td');   tdCpf.textContent = r.colaborador_cpf || '‚Äî';
        const tdCtps = document.createElement('td');  tdCtps.textContent = r.colaborador_ctps || '‚Äî';
        const tdSerie = document.createElement('td'); tdSerie.textContent = r.colaborador_serie || '‚Äî';
        const tdOc = document.createElement('td');    tdOc.textContent = r.data_ocorrencia ? new Date(r.data_ocorrencia).toLocaleDateString() : '‚Äî';
        const tdAp = document.createElement('td');    tdAp.textContent = r.data_aplicacao ? new Date(r.data_aplicacao).toLocaleDateString() : '‚Äî';
        const tdTp = document.createElement('td');    tdTp.textContent = r.tipo || '‚Äî';

        const tdAcoes = document.createElement('td');
        const btnEdit = document.createElement('button'); btnEdit.className='icon'; btnEdit.title='Editar'; btnEdit.textContent='‚úèÔ∏è';
        const btnDel  = document.createElement('button'); btnDel.className ='icon'; btnDel.title ='Excluir'; btnDel.textContent='üóëÔ∏è';
        btnEdit.addEventListener('click', ()=>startEdit(r));
        btnDel .addEventListener('click', ()=>delAdv(r.id, r.arquivo_path));
        tdAcoes.append(btnEdit, btnDel);

        tr.append(tdNome,tdCpf,tdCtps,tdSerie,tdOc,tdAp,tdTp,tdAcoes);
        E.tblReg.appendChild(tr);
      }
    }

    // filtro din√¢mico
    E.filter.addEventListener('input', ()=>{
      const f = E.filter.value.toLowerCase().trim();
      const flt = advCache.filter(x=>{
        const n=(x.colaborador_nome||x.colaborador||'').toLowerCase();
        const cpf=(x.colaborador_cpf||'').toLowerCase();
        const ctps=(x.colaborador_ctps||'').toLowerCase();
        return n.includes(f) || cpf.includes(f) || ctps.includes(f);
      });
      renderAdv(flt);
    });

    async function delAdv(id, arquivo_path){
      if(!confirm('Excluir este registro?')) return;
      await supabaseClient.from('adv_registros').delete().eq('id', id);
      if(arquivo_path){ await supabaseClient.storage.from(BUCKET).remove([arquivo_path]); }
      // fallback de 2s (al√©m do realtime)
      setTimeout(loadAdv, 2000);
    }

    /*************** CADASTRO/EDI√á√ÉO DE ADVERT√äNCIA ***************/
    function effectiveTipo(){
      const t = E.f_tipo.value;
      if(t === 'Verbal') return `Verbal (${E.f_verbal_sub.value})`;
      return t;
    }
    function toggleVerbal(){
      E.f_verbal_grp.style.display = (E.f_tipo.value === 'Verbal') ? 'block' : 'none';
    }
    E.f_tipo.addEventListener('change', ()=>{ toggleVerbal(); saveDraft(); });
    E.f_verbal_sub.addEventListener('change', saveDraft);

    // Salva rascunho (mant√©m ao trocar de tela)
    function saveDraft(){
      const draft = {
        colaborador_id: E.f_colab_id.value || '',
        data_ocorrencia: E.f_data_oc.value || '',
        data_aplicacao:  E.f_data_ap.value || '',
        tipo: E.f_tipo.value || 'Verbal',
        verbal_sub: E.f_verbal_sub.value || 'Atraso',
      };
      localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
    }
    function loadDraft(){
      const raw = localStorage.getItem(DRAFT_KEY);
      if(!raw) return;
      try{
        const d = JSON.parse(raw);
        if(d.colaborador_id) E.f_colab_id.value = d.colaborador_id;
        if(d.data_ocorrencia) E.f_data_oc.value = d.data_ocorrencia;
        if(d.data_aplicacao)  E.f_data_ap.value = d.data_aplicacao;
        if(d.tipo) E.f_tipo.value = d.tipo;
        if(d.verbal_sub) E.f_verbal_sub.value = d.verbal_sub;
        toggleVerbal(); syncColabInfo();
      }catch{}
    }
    // Observa mudan√ßas para manter rascunho
    [E.f_colab_id,E.f_data_oc,E.f_data_ap,E.f_tipo,E.f_verbal_sub].forEach(el=>el.addEventListener('input', saveDraft));

    // Novo / Limpar
    function resetForm(keepDraft=false){
      E.f_editing_id.value = '';
      if(!keepDraft){
        localStorage.removeItem(EDIT_KEY);
        localStorage.removeItem(DRAFT_KEY);
      }
      const today = new Date().toISOString().slice(0,10);
      E.f_data_oc.value = today; E.f_data_ap.value = today;
      E.f_tipo.value = 'Verbal'; E.f_verbal_sub.value = 'Atraso';
      E.f_file.value = '';
      toggleVerbal(); saveDraft();
    }
    document.getElementById('btn-new-adv').addEventListener('click', ()=>{ resetForm(false); setTab('adv'); });
    document.getElementById('btn-clear-adv').addEventListener('click', ()=>resetForm(false));

    // Come√ßar edi√ß√£o a partir da listagem
    function startEdit(r){
      setTab('adv');
      E.f_editing_id.value = r.id;
      localStorage.setItem(EDIT_KEY, r.id);
      // Preenche
      if(r.colaborador_id){ E.f_colab_id.value = r.colaborador_id; }
      E.f_data_oc.value = r.data_ocorrencia?.substring(0,10) || '';
      E.f_data_ap.value = r.data_aplicacao?.substring(0,10) || '';
      // tipo pode vir "Verbal (Atraso)" -> separa
      const m = /^Verbal\s*\((.+)\)$/.exec(r.tipo||'');
      if(m){ E.f_tipo.value='Verbal'; E.f_verbal_sub.value = m[1]; }
      else { E.f_tipo.value = r.tipo || 'Verbal'; }
      toggleVerbal(); syncColabInfo(); saveDraft();
      window.scrollTo({top:0,behavior:'smooth'});
    }

    // Se estava editando e saiu da aba, preserva
    function restoreEditing(){
      const id = localStorage.getItem(EDIT_KEY);
      if(!id) { loadDraft(); return; }
      // mant√©m apenas o ID para informar no submit; o rascunho preencheu o resto
      E.f_editing_id.value = id;
      loadDraft();
    }

    // Submit (insert ou update)
    E.formAdv.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const colaborador_id = E.f_colab_id.value || null;
      if(!colaborador_id) return alert('Selecione um colaborador.');

      const nomeSnapshot = E.f_colab_id.selectedOptions[0]?.textContent || null;

      const payload = {
        colaborador_id,
        colaborador: nomeSnapshot,
        data_ocorrencia: E.f_data_oc.value,
        data_aplicacao:  E.f_data_ap.value,
        tipo:            effectiveTipo(),
      };

      // upload opcional
      const file = E.f_file.files[0];
      let newPath = null;
      if (file){
        const ext = (file.name.split('.').pop() || '').toLowerCase();
        if(!['png','pdf'].includes(ext)) return alert('Envie um PNG ou PDF.');
        const path = `${crypto.randomUUID?.() || Math.random().toString(36).slice(2)}/${Date.now()}_${file.name}`;
        const { error: upErr } = await supabaseClient.storage.from(BUCKET).upload(path, file, { cacheControl: '3600', upsert:false });
        if(upErr){ alert('Falha no upload: '+upErr.message); return; }
        newPath = path;
        payload.arquivo_path = path;
      }

      const editingId = E.f_editing_id.value || localStorage.getItem(EDIT_KEY) || '';
      if(editingId){
        const { error } = await supabaseClient.from('adv_registros').update(payload).eq('id', editingId);
        if(error){ alert('Erro ao atualizar: '+error.message); return; }
      }else{
        const { error } = await supabaseClient.from('adv_registros').insert(payload);
        if(error){ alert('Erro ao salvar: '+error.message); return; }
      }

      // Vai para Registros
      setTab('regs');
      await loadAdv();

      // Limpa estado de edi√ß√£o, mas mant√©m um rascunho novo pronto
      resetForm(false);
      localStorage.removeItem(EDIT_KEY);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    /*************** UTILS & INIT ***************/
    function escapeHtml(s){return (s||'').toString().replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}

    // Evita assinaturas duplicadas
    let rtBound = false;
    async function bindRealtime(){
      if(rtBound) return; rtBound = true;
      supabaseClient.channel('colabs-rt')
        .on('postgres_changes', { event:'*', schema:'public', table:'colaboradores' }, ()=>{ loadColabs(); setTimeout(loadColabs, 2000); })
        .subscribe();
      supabaseClient.channel('adv-rt')
        .on('postgres_changes', { event:'*', schema:'public', table:'adv_registros' }, ()=>{ loadAdv(); setTimeout(loadAdv, 2000); })
        .subscribe();
    }

    (async function init(){
      const { data: { session } } = await supabaseClient.auth.getSession();
      setLogged(session);

      // Datas padr√£o
      const today = new Date().toISOString().slice(0,10);
      E.f_data_oc.value = today; E.f_data_ap.value = today;
      toggleVerbal();

      if(session){
        setTab('colab');              // Colaboradores como tela principal
        await loadColabs();
        await loadAdv();
        bindRealtime();
        restoreEditing();             // mant√©m rascunho/edi√ß√£o se existirem
      }

      supabaseClient.auth.onAuthStateChange((_e, s)=>{
        setLogged(s);
        if(s){ loadColabs(); loadAdv(); bindRealtime(); setTab('colab'); restoreEditing(); }
      });
    })();
  </script>
</body>
</html>
