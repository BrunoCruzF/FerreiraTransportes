<!DOCTYPE html>

<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>Controle de Advert√™ncias</title>
<link href="data:," rel="icon"/>
<style>
    *{box-sizing:border-box}
    :root{
      --bg:#0b1220; --bg2:#0f172a; --card:#0f1628; --card2:#0c1325; --border:#1f2a44;
      --txt:#e5e7eb; --muted:#9aa4b2; --accent:#22c55e; --accentText:#06270e;
      --btnText:#e5e7eb; --tableHead:#0a1120; --field:#0a1120; --fieldBorder:#253555; --fieldShadow:rgba(0,0,0,.35);
      --danger:#ef4444; --dangerBorder:#7f1d1d;
    }
    body[data-theme="light"]{
      --bg:#f5f7fb; --bg2:#eef2f9; --card:#ffffff; --card2:#f8fafc; --border:#e5e7eb;
      --txt:#0f172a; --muted:#596173; --accent:#2563eb; --accentText:#ffffff;
      --btnText:#0f172a; --tableHead:#f4f6fb; --field:#ffffff; --fieldBorder:#d9dee8; --fieldShadow:rgba(9,30,66,.15);
      --danger:#dc2626; --dangerBorder:#7f1d1d;
    }
    @media (prefers-color-scheme: light){
      body:not([data-theme]){--bg:#f5f7fb;--bg2:#eef2f9;--card:#ffffff;--card2:#f8fafc;--border:#e5e7eb;--txt:#0f172a;--muted:#596173;--accent:#2563eb;--accentText:#fff;--btnText:#0f172a;--tableHead:#f4f6fb;--field:#fff;--fieldBorder:#d9dee8;--fieldShadow:rgba(9,30,66,.15)}
    }
    html,body{height:100%}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,sans-serif;color:var(--txt);
      background:linear-gradient(180deg,var(--bg),var(--bg2));display:flex;flex-direction:column;transition:background .25s,color .25s
    }
    .topbar{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:14px;padding:10px 16px;background:rgba(11,18,32,.08);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    body[data-theme="light"] .topbar{background:rgba(255,255,255,.7)}
    .brand{display:flex;align-items:center;gap:10px}
    .brand a{display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit}
    .brand img.logo-img{height:clamp(48px,8vh,80px);width:auto;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.15)}
    .brand h1{margin:0;font-size:18px;letter-spacing:.2px}
    .userbox{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:14px}
    .icon-btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--btnText);cursor:pointer;font-weight:600}
    .container{max-width:1320px;width:100%;margin:24px auto;padding:0 16px;flex:1}
    .container-sm{max-width:420px;width:100%;margin:40px auto;padding:0 16px}
    .card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 18px 40px rgba(0,0,0,.10)}
    .tabs{display:flex;gap:10px;margin-bottom:12px}
    .tabs button{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--txt);cursor:pointer;font-weight:700}
    .tabs button.active{background:var(--accent);color:var(--accentText);border-color:transparent}
    .grid-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{display:block;font-size:14px;color:var(--muted)}
    .field{width:100%;margin-top:6px;padding:12px 14px;border-radius:14px;border:1.5px solid var(--fieldBorder);background:var(--field);
      box-shadow:0 8px 20px var(--fieldShadow);color:var(--txt);outline:none;transition:border-color .15s,box-shadow .15s}
    .field:focus{border-color:color-mix(in oklab,var(--accent) 60%,var(--fieldBorder) 40%);box-shadow:0 0 0 4px color-mix(in oklab,var(--accent) 25%, transparent)}
    input[readonly].field{opacity:.9}
    select.field,select.field option{color:var(--txt);background:var(--field)}
    body[data-theme="light"] select.field,body[data-theme="light"] select.field option{color:#0f172a;background:#fff}
    button{padding:12px 16px;border-radius:12px;border:1px solid var(--border);cursor:pointer;font-weight:700}
    .primary{background:var(--accent);color:var(--accentText);border-color:transparent}
    .secondary{background:transparent;color:var(--btnText)}
    .danger{background:var(--danger);color:#fff;border-color:var(--dangerBorder)}
    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px}
    th,td{border:1px solid var(--border);padding:10px;text-align:left}
    th{background:var(--tableHead)}
    a{color:color-mix(in oklab,var(--accent) 70%,#fff 30%);text-decoration:underline}
    .muted{color:var(--muted)}
    .hidden{display:none}
    .footer{text-align:center;padding:14px;color:var(--muted);font-size:12px}

    .icon{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:transparent;cursor:pointer;font-size:18px}
    .actions-inline{display:flex;gap:8px;align-items:center}

    .grp{border:1px solid var(--border);border-radius:12px;margin-top:12px;overflow:hidden}
    .grp-h{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;background:var(--tableHead);cursor:pointer}
    .grp-h strong{font-size:16px}
    .grp-h small{color:var(--muted)}
    .grp-b{display:none;padding:0 10px 10px}
    .grp.open .grp-b{display:block}
    .pill{background:var(--accent);color:var(--accentText);border-radius:999px;padding:2px 10px;font-weight:700}

    /* Combobox (Colaborador) */
    .combo{position:relative}
    .combo-input{position:relative}
    .combo-list{position:absolute;z-index:6;top:100%;left:0;right:0;margin-top:6px;background:var(--card);border:1px solid var(--border);border-radius:12px;max-height:280px;overflow:auto;box-shadow:0 18px 40px rgba(0,0,0,.18)}
    .combo-item{padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;justify-content:space-between;gap:10px}
    .combo-item:last-child{border-bottom:none}
    .combo-item small{color:var(--muted)}
    .combo-item.active, .combo-item:hover{background:color-mix(in oklab,var(--accent) 18%, transparent)}

    /* Toasts */
    .toasts{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:10px;z-index:20}
    .toast{background:var(--card);border:1px solid var(--border);color:var(--txt);padding:10px 14px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.18);min-width:220px}
    .toast.ok{border-color:rgba(34,197,94,.6)}
    .toast.err{border-color:rgba(239,68,68,.7)}

    /* Modal de confirma√ß√£o / info */
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:30}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:16px;max-width:560px;width:92%;box-shadow:0 22px 60px rgba(0,0,0,.35)}
    .modal-h{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:800}
    .modal-b{padding:16px}
    .modal-f{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
    @media (max-width:820px){.grid-4{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr}.brand h1{font-size:16px}}
    @media (max-width:480px){.grid-4,.grid-3{grid-template-columns:1fr}}
  
/* === Dashboard === */
.dash-grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
.dash-card{border:1px solid var(--border);background:var(--card);border-radius:14px;padding:14px}
.dash-label{color:var(--muted);font-size:12px}
.dash-value{font-size:26px;font-weight:800;margin-top:6px;letter-spacing:.2px}
.dash-sub{color:var(--muted);font-size:12px;margin-top:4px}
.grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
.subcard{border:1px solid var(--border);background:var(--card);border-radius:14px;padding:14px}
.evo-list{display:flex;flex-direction:column;gap:10px}
.evo-row{display:grid;grid-template-columns:140px 1fr 52px;gap:12px;align-items:center}
.evo-bar{height:10px;border-radius:999px;background:var(--border);overflow:hidden}
.evo-bar > div{height:100%;background:var(--accent)}
@media (max-width: 980px){
  .dash-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid-2{grid-template-columns:1fr}
  .evo-row{grid-template-columns:120px 1fr 44px}
}
</style>
</head>
<body>
<header class="topbar">
<div class="brand">
<a href="#" id="home-link">
<img alt="Ferreira Transportes &amp; Log√≠stica" class="logo-img" src="./logo.png"/>
<h1>Controle de Advert√™ncias</h1>
</a>
</div>
<div class="userbox">
<button class="icon-btn" id="btn-theme">üåô Tema</button>
<span id="user-email">Deslogado</span>
<button class="icon-btn hidden" id="btn-logout">Sair</button>
</div>
</header>
<!-- LOGIN -->
<main class="container-sm" id="view-auth">
<section class="card">
<h2 style="margin:0 0 12px">Acesse sua conta</h2>
<label>E-mail <input autocomplete="username" class="field" id="email" placeholder="voce@empresa.com.br" type="email"/></label>
<label>Senha  <input autocomplete="current-password" class="field" id="password" placeholder="********" type="password"/></label>
<div class="row">
<button class="primary" id="btn-login">Entrar</button>
<button class="secondary" id="btn-signup">Criar conta</button>
<button class="secondary" id="btn-recover">Esqueci minha senha</button>
</div>
<p class="muted" id="auth-msg"></p>
</section>
</main>
<!-- APP -->
<main class="container hidden" id="view-app">
<div class="tabs">
<button class="active" data-tab="colab">Colaboradores</button>
<button data-tab="adv">Advert√™ncias</button>
<button data-tab="regs">Registros de Advert√™ncia</button>
<button data-tab="dash">Painel Executivo</button>
</div>

<!-- DASHBOARD -->
<section class="card hidden" id="tab-dash">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h2 style="margin:0">üìä Painel Executivo</h2>
    <div class="muted" id="dash_ref" style="font-size:12px">Base: registros de advert√™ncia</div>
  </div>

  <div class="dash-grid" style="margin-top:16px">
    <div class="dash-card">
      <div class="dash-label">Total no m√™s</div>
      <div class="dash-value" id="dash_total">0</div>
    </div>
    <div class="dash-card">
      <div class="dash-label">Verbal</div>
      <div class="dash-value" id="dash_verbal">0</div>
    </div>
    <div class="dash-card">
      <div class="dash-label">Escrita</div>
      <div class="dash-value" id="dash_escrita">0</div>
    </div>
    <div class="dash-card">
      <div class="dash-label">Reincid√™ncia (Top 1)</div>
      <div class="dash-value" id="dash_top1">‚Äî</div>
      <div class="dash-sub" id="dash_top1_sub">‚Äî</div>
    </div>
  </div>

  <div class="grid-2" style="margin-top:18px">
    <div class="subcard">
      <h3 style="margin:0 0 10px">Motivos mais recorrentes (m√™s)</h3>
      <ol id="dash_motivos" style="margin:0;padding-left:18px"></ol>
      <div class="muted" id="dash_motivos_empty" style="display:none;margin-top:10px">Sem dados no m√™s.</div>
    </div>
    <div class="subcard">
      <h3 style="margin:0 0 10px">Top 5 colaboradores (m√™s)</h3>
      <ol id="dash_colab" style="margin:0;padding-left:18px"></ol>
      <div class="muted" id="dash_colab_empty" style="display:none;margin-top:10px">Sem dados no m√™s.</div>
    </div>
  </div>

  <div class="subcard" style="margin-top:18px">
    <h3 style="margin:0 0 10px">Evolu√ß√£o (√∫ltimos 6 meses)</h3>
    <div id="dash_evo" class="evo-list"></div>
    <div class="muted" style="margin-top:10px">Dica: isso √© o tipo de vis√£o que dono gosta: tend√™ncia, concentra√ß√£o e reincid√™ncia.</div>
  </div>
</section>

<!-- COLABORADORES -->
<section class="card" id="tab-colab">
<div class="row" style="justify-content:space-between;align-items:center">
<h2 style="margin:0">Colaboradores</h2>
<button class="primary" id="toggle-colab-form">Cadastrar Colaborador</button>
</div>
<form class="grid-3 hidden" id="form-colab" style="margin-top:16px">
<label>Nome  <input class="field" id="c_nome" placeholder="Ex.: Jandira Silva" required=""/></label>
<label>CPF   <input class="field" id="c_cpf" placeholder="000.000.000-00"/></label>
<label>CTPS  <input class="field" id="c_ctps" placeholder="CTPS"/></label>
<label>S√©rie <input class="field" id="c_serie" placeholder="S√©rie"/></label>
<div class="row" style="grid-column:1/-1">
<button class="primary" type="submit">Adicionar</button>
<button class="secondary" id="cancel-colab-form" type="button">Cancelar</button>
</div>
</form>
<table style="margin-top:16px">
<thead>
<tr>
<th>Nome</th>
<th>CPF</th>
<th>CTPS</th>
<th>S√©rie</th>
<th style="width:1%"></th>
</tr>
</thead>
<tbody id="tbl-colab"></tbody>
</table>
<p class="muted" id="colab-empty">Nenhum colaborador cadastrado.</p>
</section>
<!-- ADVERT√äNCIAS -->
<section class="card hidden" id="tab-adv">
<div class="row" style="justify-content:space-between;align-items:center">
<h2 style="margin:0">Cadastrar Advert√™ncia</h2>
<div>
<button class="icon" id="btn-new-adv" title="Nova advert√™ncia">üÜï</button>
<button class="icon" id="btn-clear-adv" title="Limpar formul√°rio">üßπ</button>
</div>
</div>
<form class="grid-4" id="form-adv">
<input id="f_editing_id" type="hidden"/>
<label class="combo">Colaborador
          <div class="combo-input">
<input autocomplete="off" class="field" id="f_colab_search" placeholder="Digite para pesquisar..."/>
<input id="f_colaborador_id" type="hidden"/>
</div>
<div class="combo-list hidden" id="combo-list"></div>
</label>
<label>CPF  <input class="field" id="f_cpf" placeholder="‚Äî" readonly=""/></label>
<label>CTPS <input class="field" id="f_ctps" placeholder="‚Äî" readonly=""/></label>
<label>S√©rie<input class="field" id="f_serie" placeholder="‚Äî" readonly=""/></label>
<label>Data da ocorr√™ncia <input class="field" id="f_data_ocorrencia" required="" type="date"/></label>
<label>Data da aplica√ß√£o  <input class="field" id="f_data_aplicacao" required="" type="date"/></label>
<label>Tipo de advert√™ncia
          <select class="field" id="f_tipo" required="">
<option>Verbal</option>
<option>Escrita</option>
</select>
</label>
<label id="grp_verbal">Subtipo
          <select class="field" id="f_verbal_sub">
<option>Falta n√£o justificada</option>
<option>Atraso</option>
<option>N√£o registrou o ponto</option>
<option>Insubordina√ß√£o</option>
<option>Indisciplina</option>
<option value="N√£o informado">N√£o informado</option></select>
</label>
<label style="grid-column:1/-1">Anexo (PNG ou PDF)
          <input accept=".png,.pdf,image/png,application/pdf" class="field" id="f_arquivo" type="file"/>
</label>
<label style="grid-column:1/-1">Observa√ß√£o
          <textarea class="field" id="f_observacao" placeholder="Escreva um breve contexto ou detalhes..." rows="3"></textarea>
</label>
<div class="row" style="grid-column:1/-1">
<button class="primary" type="submit">üíæ Salvar</button>
</div>
</form>
<p class="muted" style="margin-top:8px">O formul√°rio guarda rascunho automaticamente ao trocar de aba.</p>
</section>
<!-- REGISTROS AGRUPADOS -->
<section class="card hidden" id="tab-regs">
<div class="row" style="justify-content:space-between;align-items:center">
<h2 style="margin:0">Registros de Advert√™ncia</h2>
<input class="field" id="filter" placeholder="Filtrar por colaborador, CPF ou CTPS" style="max-width:420px"/>
</div>
<div id="grp-container" style="margin-top:12px"></div>
<p class="muted" id="empty">Nenhum registro ainda.</p>
</section>
</main>
<footer class="footer">Desenvolvido por Bruno Ferreira da Cruz</footer>
<!-- Modal -->
<div class="modal-back" id="modal-back">
<div aria-labelledby="m-title" aria-modal="true" class="modal" role="dialog">
<div class="modal-h" id="m-title">Confirmar</div>
<div class="modal-b" id="m-body">Tem certeza?</div>
<div class="modal-f">
<button class="secondary" id="m-cancel">Cancelar</button>
<button class="danger" id="m-ok">Excluir</button>
</div>
</div>
</div>
<!-- Toasts -->
<div class="toasts" id="toasts"></div>
<script src="https://unpkg.com/@supabase/supabase-js@2.45.2/dist/umd/supabase.js"></script>
<script>
    /* === CONFIG === */
    const SUPABASE_URL="https://bgophlququlizkwioveu.supabase.co";
    const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJnb3BobHF1cXVsaXprd2lvdmV1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMjM3NDgsImV4cCI6MjA3MDc5OTc0OH0.eJQkx1FDhjeNkKRsRuP2qSEMLvj_u_S_tRevmATJECc";
    const BUCKET='adv_docs';
    const supabaseClient = supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

    const DRAFT_KEY='adv_form_d10';
    const EDIT_KEY='adv_edit_id_d10';

    /* === HELPERS === */
    function $(s){return document.querySelector(s)}
    function $$(s){return document.querySelectorAll(s)}
    function esc(s){return (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}
    const wait = ms => new Promise(r=>setTimeout(r,ms));

    // === FUN√á√ïES DE DATA (corrigem o fuso) ===
    // yyyy-mm-dd -> ISO em "meio-dia" local
    function toIsoNoonLocal(dateStr){
      if(!dateStr) return null;
      const [y,m,d] = dateStr.split('-').map(Number);
      const localNoon = new Date(y, m-1, d, 12, 0, 0);
      return localNoon.toISOString();
    }
    // ISO/Date/string -> dd/mm/aaaa (sem new Date())
    function formatDateLocal(dateLike){
      if(!dateLike) return '‚Äî';
      const s = String(dateLike);
      const base = s.includes('T') ? s.split('T')[0] : s;
      const [y,m,d] = base.split('-');
      if(!y||!m||!d) return s;
      return `${d}/${m}/${y}`;
    }
    // ISO/Date/string -> yyyy-mm-dd para input[type=date]
    function toInputDateValue(dateLike){
      if(!dateLike) return '';
      const s = String(dateLike);
      return s.includes('T') ? s.split('T')[0] : s;
    }
    // hoje local -> yyyy-mm-dd sem UTC
    function todayInputLocal(){
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    // normaliza√ß√£o para busca
    const fold  = v => (v ?? '').toString().normalize('NFKD').replace(/[\u0300-\u036f]/g,'');
    const lower = v => fold(v).toLowerCase();
    const digits = v => (v ?? '').toString().replace(/\D/g,'');

    /* === Toaster === */
    const toasts = $('#toasts');
    function toast(txt, kind='ok', ms=2000){
      const t=document.createElement('div'); t.className=`toast ${kind}`; t.textContent=txt;
      toasts.appendChild(t);
      setTimeout(()=>{t.style.opacity='0'; t.style.transform='translateY(6px)';}, ms-300);
      setTimeout(()=>t.remove(), ms);
    }

    /* === Modal Confirm / Info === */
    const modal = {
      back: $('#modal-back'), title: $('#m-title'), body: $('#m-body'), ok: $('#m-ok'), cancel: $('#m-cancel')
    };
    function confirmModal({title='Confirmar', body='Tem certeza?', okText='Excluir', okClass='danger'}){
      return new Promise(resolve=>{
        modal.title.textContent=title;
        modal.body.innerHTML=body;
        modal.ok.textContent=okText;
        modal.ok.className=okClass;
        modal.back.style.display='flex';
        function close(v){modal.back.style.display='none'; modal.cancel.onclick=null; modal.ok.onclick=null; resolve(v);}
        modal.cancel.onclick=()=>close(false);
        modal.ok.onclick=()=>close(true);
        modal.back.onclick=e=>{ if(e.target===modal.back) close(false); };
      });
    }
    function showInfo(title, html){
      modal.title.textContent = title || 'Informa√ß√£o';
      modal.body.innerHTML = html || '<p class="muted">Sem conte√∫do.</p>';
      modal.ok.textContent = 'Fechar';
      modal.ok.className = 'secondary';
      modal.back.style.display = 'flex';
      const close = ()=>{ modal.back.style.display='none'; modal.cancel.onclick=null; modal.ok.onclick=null; };
      modal.cancel.onclick = close;
      modal.ok.onclick = close;
      modal.back.onclick = (e)=>{ if(e.target===modal.back) close(); };
    }

    /* === Debounce + rascunho silencioso === */
    function debounce(fn, ms){ let t; const d=(...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),ms)}; d.flush=()=>{clearTimeout(t);fn()}; return d; }
    function saveDraft(){
      localStorage.setItem(DRAFT_KEY, JSON.stringify({
        colaborador_id:E.f_colab_id.value||'',
        colaborador_busca:E.f_search.value||'',
        data_ocorrencia:E.f_oc.value||'',
        data_aplicacao:E.f_ap.value||'',
        tipo:E.f_tipo.value||'Verbal',
        verbal_sub:E.f_verbal_sub.value||'Falta n√£o justificada',
        observacao:E.f_obs.value||''
      }));
    }
    const saveDraftDebounced = debounce(saveDraft, 400);
    let lastDraftToast = 0;
    function saveDraftNotify(){
      saveDraft();
      const now=Date.now();
      if(now-lastDraftToast>8000){ toast('Rascunho salvo','ok',1500); lastDraftToast=now; }
    }

    /* === Tema === */
    const THEME_KEY='ft_theme';
    const E={};
    E.btnTheme=$('#btn-theme');
    function applyTheme(t){
      if(t)document.body.setAttribute('data-theme',t); else document.body.removeAttribute('data-theme');
      const isLight=(document.body.getAttribute('data-theme')==='light')||(!document.body.hasAttribute('data-theme')&&matchMedia('(prefers-color-scheme: light)').matches);
      E.btnTheme.textContent=isLight?'üåû Tema':'üåô Tema';
    }
    E.btnTheme.onclick=()=>{const c=document.body.getAttribute('data-theme');const n=c==='light'?'dark':'light';document.body.setAttribute('data-theme',n);localStorage.setItem(THEME_KEY,n);applyTheme(n);};
    applyTheme(localStorage.getItem(THEME_KEY));

    /* === Elements === */
    E.viewAuth=$('#view-auth'); E.viewApp=$('#view-app'); E.btnLogout=$('#btn-logout');
    E.email=$('#email'); E.password=$('#password'); E.msg=$('#auth-msg');
    E.tabBtns=$$('.tabs button'); E.tabColab=$('#tab-colab'); E.tabAdv=$('#tab-adv'); E.tabRegs=$('#tab-regs'); E.tabDash=$('#tab-dash');
    E.toggleColabForm=$('#toggle-colab-form'); E.cancelColabForm=$('#cancel-colab-form');
    E.formColab=$('#form-colab'); E.c_nome=$('#c_nome'); E.c_cpf=$('#c_cpf'); E.c_ctps=$('#c_ctps'); E.c_serie=$('#c_serie');
    E.tblColab=$('#tbl-colab'); E.colabEmpty=$('#colab-empty');
    E.formAdv=$('#form-adv'); E.f_edit=$('#f_editing_id'); E.f_search=$('#f_colab_search'); E.comboList=$('#combo-list');
    E.f_colab_id=$('#f_colaborador_id'); E.f_cpf=$('#f_cpf'); E.f_ctps=$('#f_ctps'); E.f_serie=$('#f_serie');
    E.f_oc=$('#f_data_ocorrencia'); E.f_ap=$('#f_data_aplicacao'); E.f_tipo=$('#f_tipo');
    E.f_verbal_grp=$('#grp_verbal'); E.f_verbal_sub=$('#f_verbal_sub'); E.f_file=$('#f_arquivo');
    E.f_obs=$('#f_observacao');
    E.btnNew=$('#btn-new-adv'); E.btnClear=$('#btn-clear-adv');
    E.filter=$('#filter'); E.grpContainer=$('#grp-container'); E.empty=$('#empty');

    /* === Tabs === */
    function setTab(n){
      saveDraftDebounced.flush?.();
      saveDraftNotify();
      E.tabBtns.forEach(b=>b.classList.toggle('active',b.dataset.tab===n));
      E.tabColab.classList.toggle('hidden',n!=='colab');
      E.tabAdv.classList.toggle('hidden',n!=='adv');
      E.tabRegs.classList.toggle('hidden',n!=='regs');
      E.tabDash.classList.toggle('hidden',n!=='dash');
      if(n==='regs' || n==='dash') loadAdv();
      if(n==='adv')  { loadDraft(); refreshCombo(); }
      window.scrollTo({top:0,behavior:'smooth'});
    }
    document.querySelector('[data-tab="colab"]').onclick=()=>setTab('colab');
    document.querySelector('[data-tab="adv"]').onclick =()=>setTab('adv');
    document.querySelector('[data-tab="regs"]').onclick=()=>setTab('regs');
    document.querySelector('[data-tab="dash"]').onclick=async ()=>{ setTab('dash'); try{ await loadAdv(); gerarDashboard(advCache||[]);}catch(e){console.error(e);} };

    /* === Auth === */
    function setLogged(s){
      const logged=!!s;
      E.viewAuth.classList.toggle('hidden',logged);
      E.viewApp.classList.toggle('hidden',!logged);
      E.btnLogout.classList.toggle('hidden',!logged);
      document.getElementById('user-email').textContent=logged?s.user.email:'Deslogado';
    }
    E.btnLogout.onclick=async()=>{await supabaseClient.auth.signOut();};
    $('#btn-login').onclick=async()=>{
      const email=E.email.value.trim(),password=E.password.value;
      if(!email||!password)return msg('Preencha e-mail e senha.',true);
      const {error}=await supabaseClient.auth.signInWithPassword({email,password}); if(error) msg(error.message,true);
    };
    $('#btn-signup').onclick=async()=>{
      const email=E.email.value.trim(),password=E.password.value;
      if(!email||!password)return msg('Defina e-mail e senha.',true);
      const {error}=await supabaseClient.auth.signUp({email,password});
      msg(error?error.message:'Conta criada! Verifique seu e-mail.',!!error);
    };
    $('#btn-recover').onclick=async()=>{
      const email=E.email.value.trim(); if(!email)return msg('Digite seu e-mail.',true);
      const {error}=await supabaseClient.auth.resetPasswordForEmail(email,{redirectTo:location.origin});
      msg(error?error.message:'Se existir, enviaremos o link.',!!error);
    };
    function msg(t,err){E.msg.textContent=t;E.msg.style.color=err?'#f87171':'#34d399';}

    /* === Colaboradores === */
    E.toggleColabForm.onclick=()=>E.formColab.classList.toggle('hidden');
    E.cancelColabForm.onclick=()=>E.formColab.classList.add('hidden');
    let colabList=[]; let advCache=[];

    async function loadColabs(){
      const {data,error}=await supabaseClient.from('colaboradores').select('*').order('nome',{ascending:true});
      if(error){console.error('loadAdv error', error); return;}
      colabList=Array.isArray(data)?data:[];
      renderColabs(colabList);
      refreshCombo();
      if(E.f_colab_id.value) setColabById(E.f_colab_id.value);
    }

    async function editColabName(c){
      const atual=c?.nome||'';
      const novo=prompt('Editar nome do colaborador:',atual);
      if(novo===null) return;
      const nome=(novo||'').trim();
      if(!nome){ toast('Nome inv√°lido','err'); return; }
      if(nome===atual) return;
      const {error}=await supabaseClient.from('colaboradores').update({nome}).eq('id',c.id);
      if(error){ alert('Erro ao atualizar: '+error.message); return; }
      toast('Nome atualizado ‚úÖ');
      await loadColabs();
    }

    function renderColabs(items){
      E.tblColab.innerHTML='';
      if(!items.length){E.colabEmpty.classList.remove('hidden');return;}
      E.colabEmpty.classList.add('hidden');
      for(const c of items){
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(c?.nome)}</td>
          <td>${esc(c?.cpf||'')}</td>
          <td>${esc(c?.ctps||'')}</td>
          <td>${esc(c?.serie||'')}</td>
          <td>
            <div class="actions-inline">
              <button class="icon" title="Editar nome">‚úèÔ∏è</button>
              <button class="icon danger" title="Excluir">üóëÔ∏è</button>
            </div>
          </td>`;
        const [btnEdit, btnDel] = tr.querySelectorAll('.actions-inline .icon');
        btnEdit.onclick = () => editColabName(c);
        btnDel.onclick = async () => {
          const ok=await confirmModal({
            title:'Excluir colaborador',
            body:`<p>Remover <b>${esc(c?.nome)}</b>?</p><p class="muted">Aten√ß√£o: n√£o remove advert√™ncias j√° lan√ßadas.</p>`,
            okText:'Sim, excluir', okClass:'danger'
          });
          if(!ok) return;
          await supabaseClient.from('colaboradores').delete().eq('id',c.id);
          setTimeout(loadColabs,2000);
        };
        E.tblColab.appendChild(tr);
      }
    }

    /* === Combobox Colaborador (blindado) === */
    let comboIndex=-1;

    function refreshCombo(){
      try{
        const qRaw = E.f_search.value ?? '';
        const q    = lower(qRaw.trim());
        const qd   = digits(qRaw);

        const base = Array.isArray(colabList) ? colabList : [];
        const list = base.filter(c=>{
          const nome = lower(c?.nome);
          const cpf  = digits(c?.cpf);
          const ctps = digits(c?.ctps);
          return q ? (nome.includes(q) || (qd && (cpf.includes(qd) || ctps.includes(qd)))) : true;
        });

        E.comboList.innerHTML='';
        if(!list.length){
          E.comboList.innerHTML = `<div class="combo-item" style="justify-content:center;color:var(--muted)">Nenhum resultado</div>`;
          E.comboList.classList.remove('hidden');
          return;
        }

        const top=list.slice(0,40);
        for(const c of top){
          const div=document.createElement('div'); div.className='combo-item'; div.dataset.id=c.id;
          div.innerHTML=`<span>${esc(c?.nome||'‚Äî')}</span><small>${esc(c?.cpf||'‚Äî')}</small>`;
          div.onclick=()=>setColabById(c.id,true);
          E.comboList.appendChild(div);
        }
        comboIndex=-1; E.comboList.classList.remove('hidden');
      }catch(err){ console.error('refreshCombo error:', err); E.comboList.classList.add('hidden'); }
    }
    function setComboActive(i){
      const items=[...E.comboList.children]; items.forEach(el=>el.classList.remove('active'));
      if(i>=0 && i<items.length){ items[i].classList.add('active'); items[i].scrollIntoView({block:'nearest'}); comboIndex=i; }
    }
    function setColabById(id,closeList=false){
      const c=(colabList||[]).find(x=>String(x?.id)===String(id));
      if(!c){ E.f_colab_id.value=''; E.f_cpf.value=E.f_ctps.value=E.f_serie.value=''; return; }
      E.f_colab_id.value=c.id; E.f_search.value=c?.nome||''; E.f_cpf.value=c?.cpf||''; E.f_ctps.value=c?.ctps||''; E.f_serie.value=c?.serie||'';
      if(closeList) E.comboList.classList.add('hidden'); saveDraftDebounced();
    }
    function resolveColab(){
      const name=lower((E.f_search.value||'').trim());
      if(!name){ E.f_colab_id.value=''; E.f_cpf.value=E.f_ctps.value=E.f_serie.value=''; saveDraftDebounced(); return; }
      const ex=(colabList||[]).find(c=>lower(c?.nome)===name)
            || (colabList||[]).find(c=>lower(c?.nome).startsWith(name))
            || (colabList||[]).find(c=>lower(c?.nome).includes(name));
      if(ex) setColabById(ex.id,true);
    }
    ['input','keyup','change'].forEach(evt=>{
      E.f_search.addEventListener(evt,()=>{ refreshCombo(); saveDraftDebounced(); });
    });
    E.f_search.addEventListener('focus',refreshCombo);
    document.addEventListener('click',e=>{
      if(!E.comboList.contains(e.target) && e.target!==E.f_search) E.comboList.classList.add('hidden');
    });
    E.f_search.addEventListener('keydown',e=>{
      const items=[...E.comboList.children];
      if(['ArrowDown','ArrowUp','Enter','Escape'].includes(e.key||'')){
        if(E.comboList.classList.contains('hidden')) E.comboList.classList.remove('hidden');
      }
      if(e.key==='ArrowDown'){ e.preventDefault(); setComboActive(Math.min(items.length-1, comboIndex+1)); }
      if(e.key==='ArrowUp'){ e.preventDefault(); setComboActive(Math.max(0, comboIndex-1)); }
      if(e.key==='Enter'){ if(comboIndex>=0 && items[comboIndex]){ items[comboIndex].click(); e.preventDefault(); } else resolveColab(); }
      if(e.key==='Escape'){ E.comboList.classList.add('hidden'); }
    });

    E.formColab.onsubmit=async(e)=>{
      e.preventDefault();
      const p={nome:E.c_nome.value.trim(),cpf:E.c_cpf.value.trim()||null,ctps:E.c_ctps.value.trim()||null,serie:E.c_serie.value.trim()||null};
      if(!p.nome) return;
      const {data,error}=await supabaseClient.from('colaboradores').insert(p).select().single();
      if(error){alert('Erro: '+error.message); return;}
      e.target.reset(); E.formColab.classList.add('hidden');
      await loadColabs();
      if(data?.id) setColabById(data.id,true);
      toast('Colaborador adicionado ‚úÖ');
    };


    /* === Dashboard (Painel Executivo) === */
    function ymLabel(d){
      const dt = (d instanceof Date) ? d : new Date(d);
      const m = dt.toLocaleString('pt-BR',{month:'short'}).replace('.','');
      return `${m}/${dt.getFullYear()}`.toLowerCase();
    }
    function isSameMonth(d, ref){
      const dt=new Date(d); return dt.getMonth()===ref.getMonth() && dt.getFullYear()===ref.getFullYear();
    }
    function gerarDashboard(registros){
      const ref=new Date();
      const doMes=(registros||[]).filter(r=>r?.data_ocorrencia && isSameMonth(r.data_ocorrencia, ref));

      const total=doMes.length;
      const verbal=doMes.filter(r=>r?.tipo==='Verbal').length;
      const escrita=doMes.filter(r=>r?.tipo==='Escrita').length;

      const setTxt=(id,val)=>{ const el=document.getElementById(id); if(el) el.textContent=val; };
      setTxt('dash_total', total);
      setTxt('dash_verbal', verbal);
      setTxt('dash_escrita', escrita);

      // Motivos
      const motivoCount={};
      for(const r of doMes){
        const k=(r?.motivo||'N√£o informado').trim();
        motivoCount[k]=(motivoCount[k]||0)+1;
      }
      const motivos=Object.entries(motivoCount).sort((a,b)=>b[1]-a[1]);

      const ulMot=document.getElementById('dash_motivos');
      const motEmpty=document.getElementById('dash_motivos_empty');
      if(ulMot){
        ulMot.innerHTML='';
        if(!motivos.length){ motEmpty && (motEmpty.style.display='block'); }
        else{
          motEmpty && (motEmpty.style.display='none');
          for(const [m,q] of motivos.slice(0,8)){
            const li=document.createElement('li');
            li.textContent=`${m} ‚Äî ${q}`;
            ulMot.appendChild(li);
          }
        }
      }

      // Colaboradores
      const colabCount={};
      for(const r of doMes){
        const k=(r?.colaborador_nome||r?.colaborador||'‚Äî').trim();
        colabCount[k]=(colabCount[k]||0)+1;
      }
      const top=Object.entries(colabCount).sort((a,b)=>b[1]-a[1]).slice(0,5);

      const ulCol=document.getElementById('dash_colab');
      const colEmpty=document.getElementById('dash_colab_empty');
      if(ulCol){
        ulCol.innerHTML='';
        if(!top.length){ colEmpty && (colEmpty.style.display='block'); }
        else{
          colEmpty && (colEmpty.style.display='none');
          for(const [n,q] of top){
            const li=document.createElement('li');
            li.textContent=`${n} ‚Äî ${q}`;
            ulCol.appendChild(li);
          }
        }
      }

      // Top1 (reincid√™ncia)
      if(top.length){
        setTxt('dash_top1', top[0][0]);
        setTxt('dash_top1_sub', `${top[0][1]} ocorr√™ncias no m√™s`);
      }else{
        setTxt('dash_top1', '‚Äî');
        setTxt('dash_top1_sub', '‚Äî');
      }

      // Evolu√ß√£o 6 meses
      const months=[];
      for(let i=5;i>=0;i--){
        const d=new Date(ref.getFullYear(), ref.getMonth()-i, 1);
        months.push(d);
      }
      const byMonth = months.map(m=>{
        const count=(registros||[]).filter(r=>r?.data_ocorrencia && isSameMonth(r.data_ocorrencia,m)).length;
        return {label: ymLabel(m), count};
      });
      const max=Math.max(1,...byMonth.map(x=>x.count));

      const evo=document.getElementById('dash_evo');
      if(evo){
        evo.innerHTML='';
        for(const x of byMonth){
          const row=document.createElement('div'); row.className='evo-row';
          const a=document.createElement('div'); a.className='muted'; a.textContent=x.label;
          const bar=document.createElement('div'); bar.className='evo-bar';
          const fill=document.createElement('div'); fill.style.width=`${(x.count/max)*100}%`;
          bar.appendChild(fill);
          const c=document.createElement('div'); c.style.textAlign='right'; c.textContent=String(x.count);
          row.appendChild(a); row.appendChild(bar); row.appendChild(c);
          evo.appendChild(row);
        }
      }

      // Refer√™ncia
      const refEl=document.getElementById('dash_ref');
      if(refEl){
        const nowTxt=ref.toLocaleDateString('pt-BR');
        refEl.textContent=`Base: registros de advert√™ncia ‚Ä¢ Atualizado em ${nowTxt}`;
      }
    }

    /* === Registros agrupados === */
    async function loadAdv(){
      const {data,error}=await supabaseClient.from('adv_registros_view').select('*');
      if(error){console.error('loadAdv error', error); return;}
      advCache=(data||[]).slice().sort((a,b)=>( (a?.colaborador_nome||'').localeCompare(b?.colaborador_nome||'') ));
      renderGrouped(advCache);
      try{ gerarDashboard(advCache); }catch(e){ console.error('gerarDashboard error', e); }
    }
    function renderGrouped(items){
      E.grpContainer.innerHTML='';
      if(!items.length){E.empty.classList.remove('hidden');return;}
      E.empty.classList.add('hidden');
      const map=new Map();
      for(const r of items){
        const k=r?.colaborador_nome||r?.colaborador||'‚Äî';
        if(!map.has(k)) map.set(k,[]);
        map.get(k).push(r);
      }
      for(const [nome,arr] of map){
        const grp=document.createElement('div'); grp.className='grp';
        const head=document.createElement('div'); head.className='grp-h';
        head.innerHTML=`<div><strong>${esc(nome)}</strong> <small class="muted">‚Ä¢ ${esc(arr[0]?.colaborador_cpf||'‚Äî')} ‚Ä¢ CTPS ${esc(arr[0]?.colaborador_ctps||'‚Äî')} ‚Ä¢ S√©rie ${esc(arr[0]?.colaborador_serie||'‚Äî')}</small></div><div><span class="pill">${arr.length}</span></div>`;
        const body=document.createElement('div'); body.className='grp-b';
        const table=document.createElement('table'); table.style.marginTop='10px';
        table.innerHTML=`<thead><tr><th>Ocorr√™ncia</th><th>Aplica√ß√£o</th><th>Tipo</th><th>Anexo</th><th>A√ß√µes</th></tr></thead>`;
        const tb=document.createElement('tbody');
        for(const r of arr){
          const tr=document.createElement('tr');
          const tdo=document.createElement('td'); tdo.textContent=formatDateLocal(r?.data_ocorrencia);
          const tda=document.createElement('td'); tda.textContent=formatDateLocal(r?.data_aplicacao);
          const ttt=document.createElement('td');
          const subt=r?.motivo||null;
          ttt.textContent=r?.tipo ? (subt ? `${r.tipo} ‚Äì ${subt}` : r.tipo) : '‚Äî';
          const tan=document.createElement('td');
          if(r?.arquivo_path){
            const {data:pub}=supabaseClient.storage.from('adv_docs').getPublicUrl(r.arquivo_path);
            const a=document.createElement('a'); a.href=pub.publicUrl; a.target='_blank'; a.rel='noopener'; a.textContent='baixar'; tan.appendChild(a);
          } else tan.textContent='‚Äî';
          const tac=document.createElement('td'); const wrap=document.createElement('div'); wrap.className='actions-inline';
          const ed=document.createElement('button'); ed.className='icon'; ed.title='Editar'; ed.textContent='‚úèÔ∏è'; ed.onclick=()=>startEdit(r);
          const ex=document.createElement('button'); ex.className='icon danger'; ex.title='Excluir'; ex.textContent='üóëÔ∏è'; ex.onclick=()=>delAdvConfirm(r);
          const obsBtn=document.createElement('button'); obsBtn.className='icon'; obsBtn.title='Ver observa√ß√£o'; obsBtn.textContent='üìù';
          obsBtn.onclick=()=>{const texto=(r?.observacao||'').trim();showInfo('Observa√ß√£o', texto?`<div style="white-space:pre-wrap">${esc(texto)}</div>`:'<p class="muted">Sem observa√ß√£o.</p>');};
          wrap.append(ed,ex,obsBtn); tac.appendChild(wrap);
          tr.append(tdo,tda,ttt,tan,tac); tb.appendChild(tr);
        }
        table.appendChild(tb); body.appendChild(table); grp.appendChild(head); grp.appendChild(body);
        head.onclick=()=>grp.classList.toggle('open');
        E.grpContainer.appendChild(grp);
      }
    }
    E.filter.oninput = () => {
  const f = lower(E.filter.value).trim();

  const filtered = (advCache || []).filter(x =>
    lower(x?.colaborador_nome || x?.colaborador).includes(f) ||
    lower(x?.colaborador_cpf || '').includes(f) ||
    lower(x?.colaborador_ctps || '').includes(f)
  );

  renderGrouped(filtered);
  try { gerarDashboard(filtered); } catch(e) { console.error('gerarDashboard error', e); }
};

    async function delAdvConfirm(r){
      const ok=await confirmModal({
        title:'Excluir advert√™ncia',
        body:`<p>Excluir advert√™ncia de <b>${esc(r?.colaborador_nome||r?.colaborador||'‚Äî')}</b>?</p>
              <p class="muted">Ocorr√™ncia: ${formatDateLocal(r?.data_ocorrencia)}</p>`,
        okText:'Sim, excluir', okClass:'danger'
      });
      if(!ok) return;
      await delAdv(r.id,r.arquivo_path);
    }
    async function delAdv(id,path){
      await supabaseClient.from('adv_registros').delete().eq('id',id);
      if(path) await supabaseClient.storage.from(BUCKET).remove([path]);
      setTimeout(loadAdv,2000);
      toast('Exclu√≠do ‚úÖ');
    }

    /* === Advert√™ncia (cadastro/edi√ß√£o) === */
    function toggleVerbal(){
      const tipo = E.f_tipo.value;
        E.f_verbal_grp.style.display =
          (tipo === 'Verbal' || tipo === 'Escrita') ? 'block' : 'none';
    }
    E.f_tipo.onchange=()=>{ toggleVerbal(); saveDraftDebounced(); }
    E.f_verbal_sub.onchange=saveDraftDebounced;

    function loadDraft(){
      const raw=localStorage.getItem(DRAFT_KEY); if(!raw) return;
      try{
        const d=JSON.parse(raw);
        if(d.colaborador_busca!==undefined) E.f_search.value=d.colaborador_busca;
        if(d.colaborador_id){E.f_colab_id.value=d.colaborador_id; setColabById(d.colaborador_id,true);} else resolveColab();
        if(d.data_ocorrencia)E.f_oc.value=d.data_ocorrencia;
        if(d.data_aplicacao)E.f_ap.value=d.data_aplicacao;
        if(d.tipo){E.f_tipo.value=d.tipo; toggleVerbal();}
        if(d.verbal_sub)E.f_verbal_sub.value=d.verbal_sub;
        if(d.observacao!==undefined)E.f_obs.value=d.observacao;
      }catch{}
    }
    ;[E.f_search,E.f_oc,E.f_ap,E.f_tipo,E.f_verbal_sub,E.f_obs].forEach(el=>el.addEventListener('input',saveDraftDebounced));

    function resetForm(){
      E.f_edit.value=''; localStorage.removeItem(EDIT_KEY);
      const today=todayInputLocal();
      E.f_search.value=''; E.f_colab_id.value=''; E.f_cpf.value=E.f_ctps.value=E.f_serie.value='';
      E.f_oc.value=today; E.f_ap.value=today; E.f_tipo.value='Verbal'; E.f_verbal_sub.value='Falta n√£o justificada'; E.f_file.value=''; E.f_obs.value='';
      toggleVerbal(); saveDraftDebounced();
    }
    E.btnNew.onclick=()=>{resetForm(); setTab('adv');};
    E.btnClear.onclick=()=>resetForm();

    function startEdit(r){
      setTab('adv'); E.f_edit.value=r.id; localStorage.setItem(EDIT_KEY,r.id);
      if(r?.colaborador_id) setColabById(r.colaborador_id,true); else {E.f_search.value=r?.colaborador_nome||''; resolveColab();}
      E.f_oc.value=toInputDateValue(r?.data_ocorrencia)||'';
      E.f_ap.value=toInputDateValue(r?.data_aplicacao)||'';
      E.f_tipo.value = (r?.tipo==='Escrita') ? 'Escrita' : 'Verbal';
      E.f_verbal_sub.value = r?.motivo || 'Falta n√£o justificada';
      E.f_obs.value=r?.observacao||'';
      toggleVerbal(); saveDraftDebounced();
    }

    function sanitizeFileName(name){
      return (name||'arquivo')
        .normalize('NFKD')
        .replace(/[\u0300-\u036f]/g,'')
        .replace(/\s+/g,'_')
        .replace(/[^a-zA-Z0-9._-]/g,'_')
        .replace(/_+/g,'_')
        .replace(/^_+|_+$/g,'');
    }

    E.formAdv.onsubmit=async(e)=>{
      e.preventDefault();
      if(!E.f_colab_id.value) resolveColab();
      if(!E.f_colab_id.value) return alert('Selecione um colaborador v√°lido.');

      const nome=E.f_search.value || ((colabList||[]).find(c=>String(c?.id)===String(E.f_colab_id.value))?.nome) || null;
      const payload={
        colaborador_id:E.f_colab_id.value,
        colaborador:nome,
        data_ocorrencia:toIsoNoonLocal(E.f_oc.value),
        data_aplicacao: toIsoNoonLocal(E.f_ap.value),
        tipo:E.f_tipo.value,
        motivo: E.f_verbal_sub.value || 'Falta n√£o justificada',
        observacao:(E.f_obs.value||'').trim()||null
      };

      const file=E.f_file.files[0];
      if(file){
        if(file.size>5*1024*1024) return alert('Limite de 5MB.');
        const ext=(file.name.split('.').pop()||'').toLowerCase();
        if(!['png','pdf'].includes(ext)) return alert('Envie PNG ou PDF.');
        const safeName=sanitizeFileName(file.name);
        const path=`${crypto.randomUUID?.()||Math.random().toString(36).slice(2)}/${Date.now()}_${safeName}`;
        const {error:upErr}=await supabaseClient.storage.from(BUCKET).upload(path,file,{cacheControl:'3600',upsert:false});
        if(upErr) return alert('Falha no upload: '+upErr.message);
        payload.arquivo_path=path;
      }

      const editingId=E.f_edit.value||localStorage.getItem(EDIT_KEY)||'';
      if(editingId){
        const {error}=await supabaseClient.from('adv_registros').update(payload).eq('id',editingId);
        if(error) return alert('Erro ao atualizar: '+error.message);
        toast('Atualizado ‚úÖ');
      }else{
        const {error}=await supabaseClient.from('adv_registros').insert(payload);
        if(error) return alert('Erro ao salvar: '+error.message);
        toast('Salvo ‚úÖ');
      }

      setTab('regs'); await loadAdv(); resetForm();
    };

    /* === Atalhos (somente Ctrl/Cmd+S) === */
    window.addEventListener('keydown',e=>{
      const key=(e.key||'').toLowerCase();
      if((e.ctrlKey||e.metaKey) && key==='s'){
        if(!E.tabAdv.classList.contains('hidden')){ e.preventDefault(); E.formAdv.requestSubmit(); }
      }
    });

    /* === Init + realtime === */
    (async function init(){
      const {data:{session}}=await supabaseClient.auth.getSession(); setLogged(session);
      const today=todayInputLocal(); E.f_oc.value=today; E.f_ap.value=today; toggleVerbal();
      if(session){ setTab('colab'); await loadColabs(); await loadAdv(); bindRt(); loadDraft(); }
      supabaseClient.auth.onAuthStateChange((_e,s)=>{ setLogged(s); if(s){ loadColabs(); loadAdv(); bindRt(); setTab('colab'); loadDraft(); } });
    })();

    function bindRt(){
      supabaseClient.channel('colabs-rt')
        .on('postgres_changes',{event:'*',schema:'public',table:'colaboradores'},()=>{loadColabs(); setTimeout(loadColabs,2000);})
        .subscribe();
      supabaseClient.channel('adv-rt')
        .on('postgres_changes',{event:'*',schema:'public',table:'adv_registros'},()=>{loadAdv(); setTimeout(loadAdv,2000);})
        .subscribe();
    }
  </script>
</body>
</html>

